<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAP EXPLORER | Discover the World</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="https://th.bing.com/th/id/R.f12bf027d9f9d30650fe3774659304a5?rik=ZOyybgCRGoEfGA&pid=ImgRaw&r=0" type="image/png">
    
    <!-- Load Supabase JS first -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Initialize Supabase -->
    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseUrl = 'https://kdwetxwmfxiikcistisi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtkd2V0eHdtZnhpaWtjaXN0aXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTYzMjMsImV4cCI6MjA3MDczMjMyM30.hV09dKEcn0vo2Z17vNmBg6FhsA52wfR6_b4uoid6pXQ';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Verify initialization
        console.log('Supabase initialized:', supabase);
    </script>
    
    <!-- Other stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="hero">
        <div class="logo-container">
            <img src="https://th.bing.com/th/id/R.f12bf027d9f9d30650fe3774659304a5?rik=ZOyybgCRGoEfGA&pid=ImgRaw&r=0" alt="MAP EXPLORER Logo" class="logo">
            <span class="brand-name">MAP EXPLORER</span>
        </div>
        
        <div class="hero-content">
            <h1>Discover the World Like Never Before</h1>
            <p>Explore interactive maps and create custom routes with MAP EXPLORER</p>
            <button class="cta-primary" id="exploreBtn">Start Exploring</button>
        </div>
    </div>

    <div class="container" id="container">
        <div class="form-container sign-up-container">
            <form id="signupForm">
                <h1>Create Account</h1>
                <div class="social-container">
                    <a href="#" class="social" onclick="signInWithGoogle()"><i class="fab fa-google"></i></a>
                    <a href="#" class="social"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social"><i class="fab fa-linkedin-in"></i></a>
                </div>
                <span>or use your email for registration</span>
                <input type="text" id="signupUsername" placeholder="Username" required />
                <input type="email" id="signupEmail" placeholder="Email" required />
                <input type="password" id="signupPassword" placeholder="Password" required />
                <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required />
                <button type="submit" class="auth-btn signup-btn">Sign Up</button>
            </form>
        </div>
        <div class="form-container sign-in-container">
            <form id="signinForm">
                <h1>Sign In</h1>
                <div class="social-container">
                    <a href="#" class="social" onclick="signInWithGoogle()"><i class="fab fa-google"></i></a>
                    <a href="#" class="social"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social"><i class="fab fa-linkedin-in"></i></a>
                </div>
                <span>or use your account</span>
                <input type="email" id="signinEmail" placeholder="Email" required />
                <input type="password" id="signinPassword" placeholder="Password" required />
                <a href="#" class="forgot-password" onclick="resetPassword()">Forgot your password?</a>
                <button type="submit" class="auth-btn signin-btn">Sign In</button>
            </form>
        </div>
        <div class="overlay-container">
            <div class="overlay">
                <div class="overlay-panel overlay-left">
                    <h1>Welcome Back!</h1>
                    <p>To keep connected with your map explorations please login with your personal info</p>
                    <button class="ghost-btn" id="signIn">Sign In</button>
                </div>
                <div class="overlay-panel overlay-right">
                    <h1>Hello, Explorer!</h1>
                    <p>Enter your personal details and start your journey with us</p>
                    <button class="ghost-btn" id="signUp">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // UI Elements
        const exploreBtn = document.getElementById('exploreBtn');
        const container = document.getElementById('container');
        const signUpButton = document.getElementById('signUp');
        const signInButton = document.getElementById('signIn');

        // Show forms when "Start Exploring" is clicked
        exploreBtn.addEventListener('click', () => {
            container.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        });

        // Hide forms when clicking outside
        container.addEventListener('click', (e) => {
            if (e.target === container) {
                container.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Toggle between sign in/up forms
        signUpButton.addEventListener('click', () => {
            container.classList.add("right-panel-active");
        });

        signInButton.addEventListener('click', () => {
            container.classList.remove("right-panel-active");
        });

        // Sign Up Handler
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = this.querySelector('.auth-btn');
            btn.innerHTML = '<span class="spinner"></span> Creating Account...';
            
            try {
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const username = document.getElementById('signupUsername').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;

                if (password !== confirmPassword) {
                    throw new Error("Passwords don't match!");
                }

                // 1. Create auth user
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            username: username
                        }
                    }
                });

                if (authError) throw authError;
                
                // 2. Wait for auth to complete
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. Create profile
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert([{ 
                        user_id: authData.user.id, 
                        username: username 
                    }]);

                if (profileError) throw profileError;
                
                alert('Account created! Please check your email to verify.');
                window.location.href = 'explore.html';
                
            } catch (error) {
                console.error('Signup error:', error);
                btn.innerHTML = 'Sign Up';
                alert(error.message || 'Signup failed. Please try again.');
            }
        });

        // Sign In Handler
        document.getElementById('signinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = this.querySelector('.auth-btn');
            btn.innerHTML = '<span class="spinner"></span> Signing In...';
            
            try {
                const email = document.getElementById('signinEmail').value;
                const password = document.getElementById('signinPassword').value;

                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;
                
                const { data: { user } } = await supabase.auth.getUser();
                sessionStorage.setItem('username', user.user_metadata.username || user.email);
                sessionStorage.setItem('email', user.email);
                
                window.location.href = 'explore.html';
            } catch (error) {
                console.error('Login error:', error);
                btn.innerHTML = 'Sign In';
                alert(error.message || 'Login failed. Please try again.');
            }
        });

        // Google OAuth Login
        async function signInWithGoogle() {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + '/explore.html'
                }
            });
            if (error) alert(error.message);
        }

        // Password Reset
        async function resetPassword() {
            const email = prompt("Please enter your email to reset password:");
            if (email) {
                const { error } = await supabase.auth.resetPasswordForEmail(email);
                if (error) {
                    alert("Error sending reset email: " + error.message);
                } else {
                    alert("Password reset link sent to your email!");
                }
            }
        }

        // Check if user is already logged in
        async function checkAuth() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    window.location.href = 'explore.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        // Run auth check on page load
        checkAuth();
    </script>
</body>
</html>